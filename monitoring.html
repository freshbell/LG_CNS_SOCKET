<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>통신 프로젝트</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.0/socket.io.min.js"></script>
</head>
<body>
    <div id="server" style="max-height: 1000px; posision: relative">
        <div id="map" style="font-size: 10px ;width:1300px; height:810px; display: inline-block;">
            <table style="width:1300px; max-height:980px">
                <tbody>

                </tbody>
            </table>
        </div>
        <div id="log" style="overflow:scroll; padding-left: 20px; display: inline-block; width: 450px; height: 810px; background-color: black; color: white;">
        </div>
    </div>
    <div id="clients" style="background-color: grey; width: 1300px; height: 400px; display: inline-block">
    </div>
    <div id="agv-info-box" style="padding-left: 20px; background-color: grey; width: 450px; height: 400px; display: inline-block">
    </div>
<style>
  table {
    border: 1px solid #444444;
  }
  tr, td {
    border: 1px solid #444444;
  }
  tr {
    width: 1000px;
    height: 25px;
  }
  td {
    width: 35px;
  }
</style>

</body>
<script language = "javascript" type = "text/javascript">
    alarms_dict = {
        '11' : '현 위치확인 안됨',
        '12' : '직진 후, 위치 오류',
        '13' : '우 90도회전 후, 위치 오류',
        '14' : '좌 90도회전 후, 위치 오류',
        '15' : '180도 회전 후, 위치 오류',
        '16' : '후진 후, 위치 오류',
        '21' : 'LOW BATTERY',
        '22' : '과전류 발생',
        '31' : 'Belt 구동 실패',
        '32' : 'Tray 구동 실패'
    }

    var socket = io.connect('http://localhost:5000');
    var agvCount = 0;
    var agvList = {};

    // tcp socket 서버랑 연결

    function findAGV(agvNo) {
        for (var i = 0; i < agvList.length; i++) {
            if (agvList[i]["AGV_NO"] == agvNo) {
                return i;
            }
        }
        return -1;
    }

    function drawAgvOnBoard(xIdx, yIdx, color, agvNo){
        var tdID = (yIdx-1)*30 + (xIdx-1);
        $("td").eq(tdID).css("background-color", color);
        $("td").eq(tdID).html(agvNo.substr(5,3));
    }

    $(document).ready(function(){
        for (var i = 0; i < 30; i++) {
            $("tbody").append("<tr id=\"row" + i + "\" style=\"height: 25px\"></tr>");
            for (var j = 0; j < 30; j++) {
                $("#row" + i).append("<td id=\"" + (j+i*30) + "\" style=\"text-align:center;\"></td>");
            }
        }

        $(document).on("click", "td", function() {
            var agvNo = 'AGV00' + $(this).html()
            var agvStatus = agvList[agvNo];
            $("#agv-info-box").html("");
            $("#agv-info-box").append("<h1 style=\"margin: 0; padding: 0;\">" + agvNo + "</h1>");
            $("#agv-info-box").append("DATA_TYPE : " + agvStatus['DATA_TYPE'] + "<br>" + 
                                "AGV_NO : " + agvStatus['AGV_NO'] + "<br>" +
                                "LOCATION : " + agvStatus['LOCATION'] + "<br>" +
                                "STATE : " + agvStatus['STATE'] + "<br>" +
                                "MODE : " + agvStatus['MODE'] + "<br>" +
                                "DIRECTION : " + agvStatus['DIRECTION'] + "<br>" +
                                "MAX_VELOCITY : " + agvStatus['MAX_VELOCITY'] + "<br>" +
                                "TILT_MAX_ANGLE : " + agvStatus['TILT_MAX_ANGLE'] + "<br>" +
                                "BELT_MAX_SPEED : " + agvStatus['BELT_MAX_SPEED'] + "<br>" +
                                "COMMAND_WAIT_TIME : " + agvStatus['COMMAND_WAIT_TIME'] + "<br>" +
                                "MIN_VOLTAGE : " + agvStatus['MIN_VOLTAGE'] + "<br>" +
                                "BATTERY_LVL : " + agvStatus['BATTERY_LVL'] + "<br>" +
                                "AGV_FIRMWARE_VERSION :" + agvStatus['AGV_FIRMWARE_VERSION']);
        })
    });

    socket.on('alarm_to_monitor', function(data) { 

        data = JSON.parse(data);
        var agvNo = data['AGV_NO'];
        var alarms = data['ALARMS'];
        for (var i = 0; i < alarms.length; i++) {
            if (alarms[i]['ALARM_STATUS'] == '1') {
                $("#log").append("<p style=\"color: red; padding: 0px; margin: 0px;\">알람 발생!!! " + agvNo + ": " + alarms_dict[alarms[i]['ALARM_CD']] + "!!!</p>");
            }
            else {
                $("#log").append("<p style=\"color: blue; padding: 0px; margin: 0px;\">알람 해제!!! " + agvNo + ": " + alarms_dict[alarms[i]['ALARM_CD']] + "!!!</p>");
            }
        }
        $('#log').scrollTop($('#log').prop('scrollHeight'));
    });

    socket.on('agv_connect_to_monitor', function(agvNo) {
        $("#log").append("<p style=\"color: white; padding: 0px; margin: 0px;\">" + agvNo + "가 연결되었습니다.</p>");
        $('#log').scrollTop($('#log').prop('scrollHeight'));
    });

    socket.on('agv_disconnect_to_monitor', function(agvNo) {
        $("#log").append("<p style=\"color: white; padding: 0px; margin: 0px;\">" + agvNo + "가 없어졌습니다.</p>");
        var origLoc = agvList[agvNo]['LOCATION'];
        var origXIdx = Number(origLoc.substr(0,4));
        var origYIdx = Number(origLoc.substr(4,4));
        drawAgvOnBoard(origXIdx, origYIdx, "#FFFFFF", "");
        delete agvList[agvNo];
        $('#log').scrollTop($('#log').prop('scrollHeight'));
    });



    socket.on('state_to_monitor', function(data){
        data = JSON.parse(data);
        var loc = data['LOCATION'];
        var xIdx = Number(loc.substr(0,4));
        var yIdx = Number(loc.substr(4,4));
        drawAgvOnBoard(xIdx, yIdx, "#00FF00", data['AGV_NO']);
        var agvNo = data['AGV_NO'];
        if (agvNo in agvList) {
            var origLoc = agvList[agvNo]['LOCATION'];
            if (origLoc != loc) {
                var origXIdx = Number(origLoc.substr(0,4));
                var origYIdx = Number(origLoc.substr(4,4));
                drawAgvOnBoard(origXIdx, origYIdx, "#FFFFFF", "");
            }
        }
        agvList[agvNo] = data;
        $('#log').scrollTop($('#log').prop('scrollHeight'));
    });


</script>
</html>